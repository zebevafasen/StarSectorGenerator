import React, { useState, useCallback, useMemo } from 'react';
import { Globe, Map as MapIcon, Home, MapPin } from 'lucide-react';
import { HEX_SIZE, HEX_HEIGHT } from './constants';
import GeneratorPanel from './components/GeneratorPanel';
import InspectorPanel from './components/InspectorPanel';
import StarMap from './components/StarMap';
import GalaxyMap from './components/GalaxyMap';
import SidebarToggle from './components/starmap/SidebarToggle';
import { postProcessSystems } from './generation/systemPostProcessing';
import { useSession } from './hooks/useSession';

export default function App() {
  const {
    gridSize, setGridSize,
    generatorSettings, setGeneratorSettings,
    systems, setSystems,
    showLeftSidebar, setShowLeftSidebar,
    showRightSidebar, setShowRightSidebar,
    viewState, setViewState,
    sectorCoords, setSectorCoords,
    viewMode, setViewMode,
    universe, setUniverse,
    showGalaxyPOIs, setShowGalaxyPOIs,
    autoGenerateOnMount, markAutoGenerated
  } = useSession();

  const [selectedCoords, setSelectedCoords] = useState(null);
  const [focusedObject, setFocusedObject] = useState(null);

  const currentBiome = useMemo(() => {
    const key = `${sectorCoords.q},${sectorCoords.r}`;
    return universe[key]?.biome;
  }, [universe, sectorCoords]);

  const handleCoordsChange = useCallback((coords) => {
    setSelectedCoords(coords);
    setFocusedObject(null);
  }, []);

  const handleJump = useCallback((direction) => {
    setSectorCoords(direction);
    setGeneratorSettings(prev => ({ ...prev, sectorCoords: direction }));
    setViewMode('local');
  }, [setSectorCoords, setGeneratorSettings, setViewMode]);

  const resetView = useCallback(
    (size = gridSize) => {
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      const gridPixelWidth = size.width * 1.5 * HEX_SIZE;
      const gridPixelHeight = size.height * HEX_HEIGHT;

      setViewState({
        scale: 1,
        x: centerX - gridPixelWidth / 2,
        y: centerY - gridPixelHeight / 2
      });
    },
    [gridSize, setViewState]
  );

  const handleSectorGenerated = useCallback(
    (newSystems, newGridSize, coords, isFresh = false, biome) => {
      const processedSystems = postProcessSystems(newSystems);
      const activeCoords = coords || sectorCoords;

      setSystems(processedSystems);
      setGridSize(newGridSize);
      setSelectedCoords(null);
      resetView(newGridSize);

      if (isFresh) {
        setUniverse({
          [`${activeCoords.q},${activeCoords.r}`]: {
            systems: processedSystems,
            gridSize: newGridSize,
            timestamp: Date.now(),
            biome
          }
        });
      } else {
        const sectorKey = `${activeCoords.q},${activeCoords.r}`;
        setUniverse(prev => ({
          ...prev,
          [sectorKey]: { 
            systems: processedSystems, 
            gridSize: newGridSize,
            timestamp: Date.now(),
            biome
          }
        }));
      }

      if (activeCoords.q !== sectorCoords.q || activeCoords.r !== sectorCoords.r) {
        setSectorCoords(activeCoords);
      }

      if (autoGenerateOnMount) {
        markAutoGenerated();
      }
    },
    [autoGenerateOnMount, resetView, setSystems, setGridSize, markAutoGenerated, sectorCoords, setSectorCoords, setUniverse]
  );

  const handleImport = useCallback((data) => {
    setSystems(data.systems);
    setGridSize(data.gridSize);
    if (data.generatorSettings) {
      setGeneratorSettings(data.generatorSettings);
    }
    if (data.universe) {
      setUniverse(data.universe);
    } else {
      const key = `${data.sectorCoords?.q || 0},${data.sectorCoords?.r || 0}`;
      setUniverse({ [key]: { systems: data.systems, gridSize: data.gridSize } });
    }
    setSelectedCoords(null);
    resetView(data.gridSize);
  }, [setSystems, setGridSize, setGeneratorSettings, resetView, setUniverse]);

  const generatorStyle = useMemo(() => ({ 
    position: 'absolute',
    left: 0,
    top: 0,
    bottom: 0,
    zIndex: 30,
    transform: showLeftSidebar ? 'translateX(0)' : 'translateX(-100%)',
    transition: 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  }), [showLeftSidebar]);

  const inspectorStyle = useMemo(() => ({
    position: 'absolute',
    right: 0,
    top: 0,
    bottom: 0,
    zIndex: 30,
    transform: showRightSidebar ? 'translateX(0)' : 'translateX(100%)',
    transition: 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  }), [showRightSidebar]);

  return (
    <div className="relative flex h-screen bg-slate-950 text-slate-100 font-sans overflow-hidden">
      {/* HUD Overlays */}
      <div className="absolute top-4 left-1/2 -translate-x-1/2 z-40 bg-slate-900 border border-slate-700 rounded-lg flex p-1 shadow-xl gap-1">
        <button
          onClick={() => handleJump({ q: 0, r: 0 })}
          className="px-2 py-1 text-xs font-bold rounded bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 transition-all border border-slate-700"
          title="Return to Sector [0,0]"
        >
          <Home size={14} />
        </button>
        <div className="w-px h-full bg-slate-800 mx-1" />
        <button
          onClick={() => setViewMode('local')}
          className={`px-3 py-1 text-xs font-bold rounded flex items-center gap-2 transition-all ${viewMode === 'local' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
        >
          <MapIcon size={14} /> Sector
        </button>
        <button
          onClick={() => setViewMode('galaxy')}
          className={`px-3 py-1 text-xs font-bold rounded flex items-center gap-2 transition-all ${viewMode === 'galaxy' ? 'bg-purple-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
        >
          <Globe size={14} /> Galaxy
        </button>
        {viewMode === 'galaxy' && (
          <>
            <div className="w-px h-full bg-slate-800 mx-1" />
            <button
              onClick={() => setShowGalaxyPOIs(!showGalaxyPOIs)}
              className={`px-3 py-1 text-xs font-bold rounded flex items-center gap-2 transition-all ${showGalaxyPOIs ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white bg-slate-800/50'}`}
              title={showGalaxyPOIs ? "Hide POIs" : "Show POIs"}
            >
              <MapPin size={14} className={showGalaxyPOIs ? "opacity-100" : "opacity-50"} />
              {showGalaxyPOIs ? "POIs On" : "POIs Off"}
            </button>
          </>
        )}
      </div>

      <SidebarToggle side="left" isOpen={showLeftSidebar} onToggle={setShowLeftSidebar} />
      <SidebarToggle side="right" isOpen={showRightSidebar} onToggle={setShowRightSidebar} />

      {/* Primary Map View */}
      {viewMode === 'local' ? (
        <StarMap
          gridSize={gridSize}
          systems={systems}
          selectedCoords={selectedCoords}
          setSelectedCoords={handleCoordsChange}
          viewState={viewState}
          setViewState={setViewState}
          sectorCoords={sectorCoords}
          onNavigate={handleJump}
          biome={currentBiome}
        />
      ) : (
        <GalaxyMap 
          universe={universe}
          initialSectorCoords={sectorCoords}
          onSectorSelect={handleJump}
          showPOIs={showGalaxyPOIs}
        />
      )}

      {/* Panels */}
      <GeneratorPanel
        onGenerate={handleSectorGenerated}
        style={generatorStyle}
        autoGenerateOnMount={autoGenerateOnMount}
        initialSettings={{ ...generatorSettings, sectorCoords }}
        onSettingsChange={setGeneratorSettings}
        systems={systems}
        gridSize={gridSize}
        onImport={handleImport}
      />

      <InspectorPanel
        gridSize={gridSize}
        systems={systems}
        sectorCoords={sectorCoords}
        selectedCoords={selectedCoords}
        setSelectedCoords={handleCoordsChange}
        focusedObject={focusedObject}
        setFocusedObject={setFocusedObject}
        onJump={handleJump}
        style={inspectorStyle}
        biome={currentBiome}
      />
    </div>
  );
}