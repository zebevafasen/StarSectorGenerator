import React, { useState, useCallback, useMemo } from 'react';
import { Globe, Map as MapIcon } from 'lucide-react';
import { HEX_SIZE, HEX_HEIGHT, SIDEBAR_WIDTH } from './constants';
import GeneratorPanel from './components/GeneratorPanel';
import InspectorPanel from './components/InspectorPanel';
import StarMap from './components/StarMap';
import GalaxyMap from './components/GalaxyMap';
import { postProcessSystems } from './generation/systemPostProcessing';
import { useSession } from './hooks/useSession';

export default function App() {
  const {
    gridSize, setGridSize,
    generatorSettings, setGeneratorSettings,
    systems, setSystems,
    showLeftSidebar, setShowLeftSidebar,
    showRightSidebar, setShowRightSidebar,
    viewState, setViewState,
    sectorCoords, setSectorCoords,
    viewMode, setViewMode,
    universe, setUniverse,
    autoGenerateOnMount, markAutoGenerated
  } = useSession();

  const [selectedCoords, setSelectedCoords] = useState(null);
  const [focusedObject, setFocusedObject] = useState(null);

  const handleCoordsChange = useCallback((coords) => {
    setSelectedCoords(coords);
    setFocusedObject(null);
  }, []);

  const handleJump = useCallback((direction) => {
    setSectorCoords(direction);
    setGeneratorSettings(prev => ({ ...prev, sectorCoords: direction }));
    // Automatically switch back to local view on jump
    setViewMode('local');
  }, [setSectorCoords, setGeneratorSettings, setViewMode]);

  const resetView = useCallback(
    (size = gridSize) => {
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      const gridPixelWidth = size.width * 1.5 * HEX_SIZE;
      const gridPixelHeight = size.height * HEX_HEIGHT;

      setViewState({
        scale: 1,
        x: centerX - gridPixelWidth / 2,
        y: centerY - gridPixelHeight / 2
      });
    },
    [gridSize, setViewState]
  );

  const handleSectorGenerated = useCallback(
    (newSystems, newGridSize, coords, isFresh = false) => {
      const processedSystems = postProcessSystems(newSystems);
      const activeCoords = coords || sectorCoords;

      setSystems(processedSystems);
      setGridSize(newGridSize);
      setSelectedCoords(null);
      resetView(newGridSize);

      // Reset archive only if starting a brand new universe (New Seed)
      if (isFresh) {
        setUniverse({
          [`${activeCoords.q},${activeCoords.r}`]: {
            systems: processedSystems,
            gridSize: newGridSize,
            timestamp: Date.now()
          }
        });
      } else {
        // Append to existing archive for navigation
        const sectorKey = `${activeCoords.q},${activeCoords.r}`;
        setUniverse(prev => ({
          ...prev,
          [sectorKey]: { 
            systems: processedSystems, 
            gridSize: newGridSize,
            timestamp: Date.now()
          }
        }));
      }

      // Sync sectorCoords in App if they differ (e.g. from a reset)
      if (activeCoords.q !== sectorCoords.q || activeCoords.r !== sectorCoords.r) {
        setSectorCoords(activeCoords);
      }

      if (autoGenerateOnMount) {
        markAutoGenerated();
      }
    },
    [autoGenerateOnMount, resetView, setSystems, setGridSize, markAutoGenerated, sectorCoords, setSectorCoords, setUniverse]
  );

  const handleImport = useCallback((data) => {
    setSystems(data.systems);
    setGridSize(data.gridSize);
    if (data.generatorSettings) {
      setGeneratorSettings(data.generatorSettings);
    }
    // If importing a full universe, we should use that
    if (data.universe) {
      setUniverse(data.universe);
    } else {
      // Just one sector
      const key = `${data.sectorCoords?.q || 0},${data.sectorCoords?.r || 0}`;
      setUniverse({ [key]: { systems: data.systems, gridSize: data.gridSize } });
    }
    setSelectedCoords(null);
    resetView(data.gridSize);
  }, [setSystems, setGridSize, setGeneratorSettings, resetView, setUniverse]);

  const generatorStyle = useMemo(() => ({ 
    position: 'absolute',
    left: 0,
    top: 0,
    bottom: 0,
    zIndex: 30,
    transform: showLeftSidebar ? 'translateX(0)' : 'translateX(-100%)',
    transition: 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  }), [showLeftSidebar]);

  const inspectorStyle = useMemo(() => ({
    position: 'absolute',
    right: 0,
    top: 0,
    bottom: 0,
    zIndex: 30,
    transform: showRightSidebar ? 'translateX(0)' : 'translateX(100%)',
    transition: 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  }), [showRightSidebar]);

  return (
    <div className="relative flex h-screen bg-slate-950 text-slate-100 font-sans overflow-hidden">
      {/* View Mode Toggle */}
      <div className="absolute top-4 left-1/2 -translate-x-1/2 z-40 bg-slate-900 border border-slate-700 rounded-lg flex p-1 shadow-xl">
        <button
          onClick={() => setViewMode('local')}
          className={`px-3 py-1 text-xs font-bold rounded flex items-center gap-2 transition-all ${viewMode === 'local' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
        >
          <MapIcon size={14} /> Sector
        </button>
        <button
          onClick={() => setViewMode('galaxy')}
          className={`px-3 py-1 text-xs font-bold rounded flex items-center gap-2 transition-all ${viewMode === 'galaxy' ? 'bg-purple-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
        >
          <Globe size={14} /> Galaxy
        </button>
      </div>

      {viewMode === 'local' ? (
        <StarMap
          gridSize={gridSize}
          systems={systems}
          selectedCoords={selectedCoords}
          setSelectedCoords={handleCoordsChange}
          viewState={viewState}
          setViewState={setViewState}
          showLeftSidebar={showLeftSidebar}
          setShowLeftSidebar={setShowLeftSidebar}
          showRightSidebar={showRightSidebar}
          setShowRightSidebar={setShowRightSidebar}
          sectorCoords={sectorCoords}
          onNavigate={handleJump}
        />
      ) : (
        <GalaxyMap 
          universe={universe}
          initialSectorCoords={sectorCoords}
        />
      )}

      <GeneratorPanel
        onGenerate={handleSectorGenerated}
        style={generatorStyle}
        autoGenerateOnMount={autoGenerateOnMount}
        initialSettings={{ ...generatorSettings, sectorCoords }}
        onSettingsChange={setGeneratorSettings}
        systems={systems}
        gridSize={gridSize}
        onImport={handleImport}
      />

      <InspectorPanel
        gridSize={gridSize}
        systems={systems}
        sectorCoords={sectorCoords}
        selectedCoords={selectedCoords}
        setSelectedCoords={handleCoordsChange}
        focusedObject={focusedObject}
        setFocusedObject={setFocusedObject}
        onJump={handleJump}
        style={inspectorStyle}
      />
    </div>
  );
}

